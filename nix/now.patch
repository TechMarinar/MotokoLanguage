From 749586e6c0d52871725691959d2380d17fa7e08b Mon Sep 17 00:00:00 2001
From: Andriy Berestovskyy <andriy.berestovskyy@dfinity.org>
Date: Fri, 4 Nov 2022 20:07:52 +0000
Subject: [PATCH] RUN-453: Use current time in `drun`

---
 rs/drun/README.adoc | 8 ++++----
 rs/drun/in.txt      | 3 +++
 rs/drun/src/lib.rs  | 5 ++---
 3 files changed, 9 insertions(+), 7 deletions(-)
 create mode 100644 rs/drun/in.txt

diff --git a/rs/drun/README.adoc b/rs/drun/README.adoc
index 705ba9d4dd..1d59f94667 100644
--- rs/drun/README.adoc
+++ rs/drun/README.adoc
@@ -8,12 +8,12 @@ node.
 
 [source,shell]
 ....
-$ drun [-c <config.json5>] <messages>
+$ bazel run //rs/drun -- [-c <config.json5>] <messages_file>
 ....
 
 * `-c <config.json5>`: (Optional) A json file containing the node configuration. If no config is
 provided, default values will be used.
-* `<messages>`: A line-based ASCII-encoded text file containing the messages to be processed.
+* `<messages_file>`: A line-based ASCII-encoded text file containing the messages to be processed.
 
 == Configuration
 
@@ -47,7 +47,7 @@ Code installation messages have the following format:
 * `<mode>` is one of `install`, `reinstall` or `upgrade`
 
 * `<canister_id>` is the desired ID for the canister to be installed, given in textual
-representation (e.g. `lg264-qjkae`) as specified in https://sdk.dfinity.org/docs/interface-spec/index.html#textual-ids.
+representation (e.g. `rwlgt-iiaaa-aaaaa-aaaaa-cai`) as specified in https://sdk.dfinity.org/docs/interface-spec/index.html#textual-ids.
 
 * `<wasmfile>` is a path to a Wasm file that should be installed in this drun execution.
 
@@ -186,7 +186,7 @@ Running the command
 
 [source,shell]
 ----
-$ drun counter.wasm in.txt
+$ bazel run //rs/drun -- ${PWD}/in.txt
 ----
 
 should result in the following output:
diff --git a/rs/drun/in.txt b/rs/drun/in.txt
new file mode 100644
index 0000000000..76d0539c11
--- /dev/null
+++ rs/drun/in.txt
@@ -0,0 +1,3 @@
+create
+install rwlgt-iiaaa-aaaaa-aaaaa-cai /home/andriy/tmp/ic/rs/timer.wasm ""
+ingress rwlgt-iiaaa-aaaaa-aaaaa-cai go "DIDL\x00\x00"
diff --git a/rs/drun/src/lib.rs b/rs/drun/src/lib.rs
index 6666b1a5a2..89f7346fae 100644
--- rs/drun/src/lib.rs
+++ rs/drun/src/lib.rs
@@ -35,8 +35,7 @@ use ic_types::{
     ingress::{IngressState, IngressStatus, WasmResult},
     messages::{MessageId, SignedIngress},
     replica_config::ReplicaConfig,
-    time::UNIX_EPOCH,
-    CanisterId, NodeId, PrincipalId, Randomness, RegistryVersion, SubnetId,
+    time, CanisterId, NodeId, PrincipalId, Randomness, RegistryVersion, SubnetId,
 };
 use slog::{Drain, Logger};
 use std::collections::BTreeMap;
@@ -320,7 +319,7 @@ fn build_batch(message_routing: &dyn MessageRouting, msgs: Vec<SignedIngress>) -
         randomness: Randomness::from([0; 32]),
         ecdsa_subnet_public_keys: BTreeMap::new(),
         registry_version: RegistryVersion::from(1),
-        time: UNIX_EPOCH,
+        time: time::current_time(),
         consensus_responses: vec![],
     }
 }
-- 
GitLab

